<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DrawRun - Connexion Strava</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .center-box {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="center-box">
        <div class="glass-card" style="padding: 3rem; border-radius: 24px;">
            <div id="loading" class="loader"></div>
            <h2 id="status">Connexion à DrawRun...</h2>
            <p id="substatus" style="color: var(--text-secondary); margin-top: 10px;">Veuillez patienter pendant la
                redirection.</p>

            <a id="retry-btn" href="#" class="btn-primary" style="display:none; margin-top: 20px;">Ouvrir
                l'application</a>
        </div>
    </div>

    <script>
        // Logic to parse params and redirect to Custom Scheme
        document.addEventListener("DOMContentLoaded", function () {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');

            const statusEl = document.getElementById('status');
            const substatusEl = document.getElementById('substatus');
            const retryBtn = document.getElementById('retry-btn');
            const loadingEl = document.getElementById('loading');

            if (error) {
                loadingEl.style.display = 'none';
                statusEl.innerText = "Erreur de connexion";
                substatusEl.innerText = "L'utilisateur a refusé ou une erreur est survenue.";
                return;
            }

            if (code) {
                // Construct Deep Link
                // Ensure this matches AndroidManifest scheme
                const deepLink = `drawrun://strava_callback${window.location.search}`;

                // Attempt Redirect
                window.location.href = deepLink;

                // Fallback UI if not installed or doesn't open immediately
                setTimeout(() => {
                    loadingEl.style.display = 'none';
                    statusEl.innerText = "Ouvrir DrawRun";
                    substatusEl.innerText = "Si l'application ne s'ouvre pas automatiquement, cliquez ci-dessous.";
                    retryBtn.href = deepLink;
                    retryBtn.style.display = 'inline-block';
                }, 1000);
            } else {
                loadingEl.style.display = 'none';
                statusEl.innerText = "Paramètres manquants";
                substatusEl.innerText = "Impossible de finaliser l'authentification.";
            }
        });
    </script>
</body>

</html>